using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class Invulnerability : MonoBehaviour
{
    private Renderer rend;
    private Color color;
    private int currentHealth;   
    private Player player;
    private bool isImmune;
    public bool IsImmune { get => isImmune; set => value = isImmune;}
    private WaitForSeconds blink;
    [SerializeField] float duration;
    

    void Start()
    {
        player = GetComponent<Player>();
        rend = GetComponent<SpriteRenderer>();
        color = rend.material.color;
        currentHealth = GetComponent<Health>().HealthCount;

        blink = new WaitForSeconds(duration / 40f);

        Physics2D.IgnoreLayerCollision(8, 9, false);
        Physics2D.IgnoreLayerCollision(8, 11, false);
    }

   // private void Update()
   // {
   //     if (player.IsDamaged && !isImmune && !player.IsBloodLost)        
   //         StartCoroutine(GetInvulnerability());        
   // }


    // Игнорим слои с врагами и ловушками
    public IEnumerator GetInvulnerability() {
        Physics2D.IgnoreLayerCollision(8,9, true);
        Physics2D.IgnoreLayerCollision(8,11, true);       
        isImmune = true;
        StartCoroutine(BlinkingSprite());

        yield return new WaitForSeconds(duration);
        
        Physics2D.IgnoreLayerCollision(8, 9, false);
        Physics2D.IgnoreLayerCollision(8, 11, false);       
        isImmune = false;
    }

    // Мерцание спрайта, чтобы не занимать анимацию
    IEnumerator BlinkingSprite()
    {
        for(int i=0; i<20; i++)
        {
            color.a = 0.1f;
            rend.material.color = color;
            yield return blink;
            color.a = 1f;
            rend.material.color = color;
            yield return blink;
        }
    }
}
